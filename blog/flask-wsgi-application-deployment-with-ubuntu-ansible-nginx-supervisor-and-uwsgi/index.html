<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 4.24.8"/><meta data-react-helmet="true" name="description" content="Matt &#x27;Upstate&#x27; Wright (He/him). Engineering team leader. Open source author and contributor. Aging hardcore punk enthusiast. LFC supporter."/><meta data-react-helmet="true" name="keywords" content="software,engineering,leadership,python,programming,open source"/><meta data-react-helmet="true" property="og:title" content="Flask/WSGI Application Deployment with Ubuntu, Ansible, Nginx, Supervisor and uWSGI"/><meta data-react-helmet="true" property="og:description" content="Matt &#x27;Upstate&#x27; Wright (He/him). Engineering team leader. Open source author and contributor. Aging hardcore punk enthusiast. LFC supporter."/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:creator" content="Matthew Wright"/><meta data-react-helmet="true" name="twitter:title" content="Flask/WSGI Application Deployment with Ubuntu, Ansible, Nginx, Supervisor and uWSGI"/><meta data-react-helmet="true" name="twitter:description" content="Matt &#x27;Upstate&#x27; Wright (He/him). Engineering team leader. Open source author and contributor. Aging hardcore punk enthusiast. LFC supporter."/><meta data-react-helmet="true" property="og:image" content="https://mattupstate.com/static/9798db320c5cad183af92ab85933ac64/38397/headshot-summary.png"/><meta data-react-helmet="true" property="og:image:width" content="2122"/><meta data-react-helmet="true" property="og:image:height" content="1070"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><style data-href="/styles.c743ec910f51898a4794.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{background:#073642}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#073642}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{background:#eee8d5;color:#657b83}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}

/*! tailwindcss v2.2.19 | MIT License | https://tailwindcss.com */

/*! modern-normalize v1.1.0 | MIT License | https://github.com/sindresorhus/modern-normalize */html{-webkit-text-size-adjust:100%;line-height:1.15;-moz-tab-size:4;-o-tab-size:4;tab-size:4}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;margin:0}hr{color:inherit;height:0}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{border-color:inherit;text-indent:0}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}button{-webkit-appearance:button}::-moz-focus-inner{border-style:none;padding:0}legend{padding:0}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}html{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}body{font-family:inherit;line-height:inherit}*,:after,:before{border:0 solid;box-sizing:border-box}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:#9ca3af;opacity:1}input::placeholder,textarea::placeholder{color:#9ca3af;opacity:1}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{color:inherit;line-height:inherit;padding:0}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{height:auto;max-width:100%}*,:after,:before{--tw-border-opacity:1;border-color:rgba(229,231,235,var(--tw-border-opacity))}h1{font-size:1.5rem;line-height:2rem}h2{font-size:1.25rem;margin-bottom:.5rem}h2,h3{line-height:1.75rem}h3{font-size:1.125rem}h4,h5{font-size:1rem;line-height:1.5rem}h5{--tw-text-opacity:1;color:rgba(75,85,99,var(--tw-text-opacity));font-weight:700}p{font-size:.875rem;line-height:1.25rem}blockquote,p{margin-bottom:1rem}blockquote{--tw-bg-opacity:1;--tw-text-opacity:1;background-color:rgba(249,250,251,var(--tw-bg-opacity));border-left:3px solid gray;color:rgba(107,114,128,var(--tw-text-opacity));font-style:italic;padding:1rem}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}@media (min-width:1536px){.container{max-width:1536px}}.mx-auto{margin-left:auto;margin-right:auto}.mt-8{margin-top:2rem}.mr-0{margin-right:0}.mr-3{margin-right:.75rem}.mb-1{margin-bottom:.25rem}.mb-3{margin-bottom:.75rem}.mb-5{margin-bottom:1.25rem}.flex{display:flex}.table{display:table}.max-w-3xl{max-width:48rem}@keyframes spin{to{transform:rotate(1turn)}}@keyframes ping{75%,to{opacity:0;transform:scale(2)}}@keyframes pulse{50%{opacity:.5}}@keyframes bounce{0%,to{animation-timing-function:cubic-bezier(.8,0,1,1);transform:translateY(-25%)}50%{animation-timing-function:cubic-bezier(0,0,.2,1);transform:none}}.flex-wrap{flex-wrap:wrap}.justify-start{justify-content:flex-start}.border-2{border-width:2px}.border{border-width:1px}.bg-gray-50{--tw-bg-opacity:1;background-color:rgba(249,250,251,var(--tw-bg-opacity))}.p-4{padding:1rem}.pt-2{padding-top:.5rem}.pt-6{padding-top:1.5rem}.pr-8{padding-right:2rem}.pr-10{padding-right:2.5rem}.pb-3{padding-bottom:.75rem}.pl-5{padding-left:1.25rem}.pl-10{padding-left:2.5rem}.text-center{text-align:center}.font-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}.text-xs{font-size:.75rem;line-height:1rem}.text-gray-500{--tw-text-opacity:1;color:rgba(107,114,128,var(--tw-text-opacity))}.text-gray-600{--tw-text-opacity:1;color:rgba(75,85,99,var(--tw-text-opacity))}.hover\:text-gray-500:hover{--tw-text-opacity:1;color:rgba(107,114,128,var(--tw-text-opacity))}*,:after,:before{--tw-shadow:0 0 #0000;--tw-ring-inset:var(--tw-empty,/*!*/ /*!*/);--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000}.filter{--tw-blur:var(--tw-empty,/*!*/ /*!*/);--tw-brightness:var(--tw-empty,/*!*/ /*!*/);--tw-contrast:var(--tw-empty,/*!*/ /*!*/);--tw-grayscale:var(--tw-empty,/*!*/ /*!*/);--tw-hue-rotate:var(--tw-empty,/*!*/ /*!*/);--tw-invert:var(--tw-empty,/*!*/ /*!*/);--tw-saturate:var(--tw-empty,/*!*/ /*!*/);--tw-sepia:var(--tw-empty,/*!*/ /*!*/);--tw-drop-shadow:var(--tw-empty,/*!*/ /*!*/);filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}blockquote>p{margin-bottom:0}code[class=language-text],pre[class=language-text]{font-size:.75rem;line-height:1rem}.navbar{position:sticky;top:0}.blog-post a{--tw-text-opacity:1;color:rgba(37,99,235,var(--tw-text-opacity));text-decoration:underline}.blog-post ul{font-size:.875rem;line-height:1.25rem;list-style-position:inside;list-style-type:disc;margin-bottom:1rem;margin-left:.75rem}.blog-links a{--tw-text-opacity:1;color:rgba(37,99,235,var(--tw-text-opacity));text-decoration:underline}.work ul{list-style-position:outside;list-style-type:disc;margin-bottom:1rem;margin-left:1rem}.employment p,.work ul{font-size:.75rem;line-height:1rem}.work h3{font-weight:500}.work h4{margin-bottom:.25rem}.talks a{--tw-text-opacity:1;color:rgba(37,99,235,var(--tw-text-opacity));text-decoration:underline}.talk-item{margin-bottom:2rem}.employment-duration{--tw-text-opacity:1;color:rgba(156,163,175,var(--tw-text-opacity));font-size:.875rem;line-height:1.25rem;margin-left:.25rem}.etc a,.work a{--tw-text-opacity:1;color:rgba(37,99,235,var(--tw-text-opacity));text-decoration:underline}.etc ul{font-size:.875rem;line-height:1.25rem;list-style-position:inside;list-style-type:disc;margin-bottom:1rem;margin-left:.75rem}@media (min-width:640px){.sm\:flex{display:flex}.sm\:w-2\/5{width:40%}.sm\:w-3\/5{width:60%}.sm\:justify-between{justify-content:space-between}.sm\:pt-0{padding-top:0}.sm\:pl-0{padding-left:0}}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><title data-react-helmet="true">Flask/WSGI Application Deployment with Ubuntu, Ansible, Nginx, Supervisor and uWSGI | mattupstate.com</title><link data-react-helmet="true" rel="canonical" href="https://mattupstate.com/blog/flask-wsgi-application-deployment-with-ubuntu-ansible-nginx-supervisor-and-uwsgi"/><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><nav class="p-4 bg-gray-50 font-mono navbar"><div class="sm:flex sm:justify-between max-w-3xl mx-auto"><div>$ <a class="hover:text-gray-500" href="/">matt</a></div><div class="pl-5 pt-2 sm:pl-0 sm:pt-0"><a class="mr-3 hover:text-gray-500" href="/work">~/work</a><a class="mr-3 hover:text-gray-500" href="/talks">~/talks</a><a class="mr-0 hover:text-gray-500" href="/etc">~/etc</a></div></div></nav><div class="pl-10 pr-10 pt-6 max-w-3xl mx-auto blog-post"><h1 class="mb-1">Flask/WSGI Application Deployment with Ubuntu, Ansible, Nginx, Supervisor and uWSGI</h1><h5 class="mb-3 text-xs text-gray-500 font-mono">Published on <!-- -->August 07, 2012</h5><hr class="mb-3"/><div><p>In this article you will learn how to use <a href="http://ansible.github.com/">Ansible</a> to deploy an arbitrary WSGI app, in this case a <a href="http://flask.pocoo.org/">Flask</a> app, to an Ubuntu server that runs <a href="http://wiki.nginx.org/">Nginx</a>, <a href="http://projects.unbit.it/uwsgi/">uWSGI</a>, and <a href="http://supervisord.org/">Supervisor</a>. This article assumes you have a basic understanding of Ubuntu, Python web application development and are using git for source control.</p>
<h2><a href=""></a>Ansible</h2>
<p>Ansible is a great devops tool. It's truly simply to understand and is easily extended with custom functionality that can be written in nearly any language. If you have not installed Ansible yet, please do by following the instructions on the <a href="http://ansible.github.com/gettingstarted.html">Getting Started</a> page.</p>
<p>This tutorial will make use of a few modules I contributed to Ansible. They include <code class="language-text">apt_repository</code>, <code class="language-text">easy_install</code>, <code class="language-text">pip</code>, and <code class="language-text">supervisorctl</code>.</p>
<h2><a href=""></a>Server Software</h2>
<p><strong><a href="http://wiki.nginx.org/">Nginx</a></strong></p>
<p>Nginx is a very fast, lightweight, and popular web server. It will be used as the front end proxy server that ushers the HTTP requests to the Flask application. It will also be used to serve the application's static files to the browser.</p>
<p><strong><a href="http://projects.unbit.it/uwsgi/">uWSGI</a></strong></p>
<p>uWSGI is a fast, stable, and full featured application container. It plays very nice with Python and WSGI applications. It will be used to run the Python application process(es) and Nginx, conveniently, supports uWSGI out of the box.</p>
<p><strong><a href="http://supervisord.org/">Supervisor</a></strong></p>
<p>Supervisor will be used to manage the uWSGI application container including starting, stoping, and restarting it when necessary. Its also useful for managing other various processes. For instance, you could use it to manage worker processes for a task queue.</p>
<h2><a href=""></a>The Flask/WSGI Application</h2>
<p>It's probably safe to say that if you're developing a Python web app you'll using a WSGI based framework. This article happens to use a very simple Flask application but this deployment method could be applied to any WSGI compatible framework.</p>
<p>The application that will be used is located at <a href="http://github.com/mattupstate/ansible-tutorial">http://github.com/mattupstate/ansible-tutorial</a>. The repository also contains the Ansible playbooks for this tutorial. Clone the repository if you would like to follow along step by step:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">git clone http://github.com/mattupstate/ansible-tutorial
cd ansible-tutorial</code></pre></div>
<h2><a href=""></a>Server Setup</h2>
<p>Before following along with this section of the tutorial you may want to have a server to run the proceeding playbooks against. I've been using a fresh, 64-bit, Ubuntu 11.04 server on Amazon EC2. If you happen to have an Amazon EC2 account you can <a href="https://console.aws.amazon.com/ec2/home?region=us-east-1#launchAmi=ami-699f3600">launch an instance of the same server (ami-699f3600)</a>.</p>
<p>Create a copy of the <code class="language-text">devops/hosts.example</code> file and make sure its located at <code class="language-text">devops/hosts</code>. Replace the current host name with the host name of your Ubuntu server.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">sed "s/something.com/&lt;your.host.name>/g" devops/hosts.example >> devops/hosts</code></pre></div>
<p>With the server/host is defined you can run the <a href="https://github.com/mattupstate/ansible-tutorial/blob/master/devops/setup_server.yml">server_setup.yml</a> playbook against it. Run the following Ansible command:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">ansible-playbook devops/setup_server.yml -i devops/hosts</code></pre></div>
<p>If your server requires a private key to access it via ssh run the previous command but append it with:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">--private-key=&lt;path_to_private_key></code></pre></div>
<p>If all goes well all the required software for running your application will be installed and configured.</p>
<h2><a href=""></a>Application Deployment</h2>
<p>The application will deployed to the server using Ansible's <a href="http://ansible.github.com/modules.html#git">git module</a>. Essentially it will pull the latest code from the repository and checkout the specified version or branch. In the case of this tutorial the <code class="language-text">HEAD</code> revision of the <code class="language-text">origin/master</code> branch is being used.</p>
<p>To deploy the application run the <a href="https://github.com/mattupstate/ansible-tutorial/blob/master/devops/deploy.yml">deploy.yml</a> playbook against the server with the following command (appending the <code class="language-text">--private-key</code> argument if necessary):</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">ansible-playbook devops/deploy.yml <span class="token parameter variable">-i</span> devops/hosts</code></pre></div>
<p>If all goes well the application should be deployed to the server and if you access the host in your browser you should see <code class="language-text">Hello World</code> appear in your browser!</p>
<h2><a href=""></a>Playbooks Explained</h2>
<p>This section explains each playbook in detail.</p>
<h3><a href=""></a>server_setup.yml</h3>
<p>The <a href="https://github.com/mattupstate/ansible-tutorial/blob/master/devops/setup_server.yml">server_setup.yml</a> playbook is made specifically for setting up an Ubuntu server to run the application in the manner described above.</p>
<h4>Configuration</h4>
<p>At the top of the file you will see the following contents:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> webservers
  <span class="token key atrule">user</span><span class="token punctuation">:</span> ubuntu
  <span class="token key atrule">sudo</span><span class="token punctuation">:</span> <span class="token boolean important">True</span></code></pre></div>
<p>This part of the file specifies which host(s) to run the playbook against, which user to run as, and wether or not to use sudo actions. In the case of this tutorial the <code class="language-text">hosts</code> attribute is set to the <code class="language-text">webservers</code> group which was defined in the <code class="language-text">devops/hosts</code> file. Additionall the default user for the newly created server is named <code class="language-text">ubuntu</code> and all actions are performed as root for simplicity.</p>
<h4>Tasks</h4>
<p>After the previous contents you will begin to see task definitions. The first four tasks are as follows:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> add nginx ppa
  <span class="token key atrule">action</span><span class="token punctuation">:</span> apt_repository repo=ppa<span class="token punctuation">:</span>nginx/stable state=present

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install common packages needed for python application development
  <span class="token key atrule">action</span><span class="token punctuation">:</span> apt pkg=$item state=installed
  <span class="token key atrule">with_items</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> libpq<span class="token punctuation">-</span>dev
    <span class="token punctuation">-</span> libmysqlclient<span class="token punctuation">-</span>dev
    <span class="token punctuation">-</span> libxml2<span class="token punctuation">-</span>dev
    <span class="token punctuation">-</span> libjpeg62
    <span class="token punctuation">-</span> libjpeg62<span class="token punctuation">-</span>dev
    <span class="token punctuation">-</span> libfreetype6
    <span class="token punctuation">-</span> libfreetype6<span class="token punctuation">-</span>dev
    <span class="token punctuation">-</span> zlib1g<span class="token punctuation">-</span>dev
    <span class="token punctuation">-</span> mysql<span class="token punctuation">-</span>client
    <span class="token punctuation">-</span> python<span class="token punctuation">-</span>dev
    <span class="token punctuation">-</span> python<span class="token punctuation">-</span>setuptools
    <span class="token punctuation">-</span> python<span class="token punctuation">-</span>imaging
    <span class="token punctuation">-</span> python<span class="token punctuation">-</span>mysqldb
    <span class="token punctuation">-</span> python<span class="token punctuation">-</span>psycopg2
    <span class="token punctuation">-</span> git<span class="token punctuation">-</span>core
    <span class="token punctuation">-</span> nginx

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install pip
  <span class="token key atrule">action</span><span class="token punctuation">:</span> easy_install name=pip

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install various libraries with pip
  <span class="token key atrule">action</span><span class="token punctuation">:</span> pip name=$item state=present
  <span class="token key atrule">with_items</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> virtualenv
    <span class="token punctuation">-</span> supervisor
    <span class="token punctuation">-</span> uwsgi</code></pre></div>
<p>These tasks install the various pieces of software necessary for running the application. Notice the use of the custom Ansible modules <code class="language-text">apt_repository</code>, <code class="language-text">easy_install</code>, and <code class="language-text">pip</code>. These are available in my <a href="https://github.com/mattupstate/ansible">Ansible fork</a>.</p>
<p>Following this are some housekeeping tasks:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> symlink imaging library files
  <span class="token key atrule">action</span><span class="token punctuation">:</span> file src=/usr/lib/x86_64<span class="token punctuation">-</span>linux<span class="token punctuation">-</span>gnu/libfreetype.so dest=/usr/lib/libfreetype.so state=link

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> symlink imaging library files
  <span class="token key atrule">action</span><span class="token punctuation">:</span> file src=/usr/lib/x86_64<span class="token punctuation">-</span>linux<span class="token punctuation">-</span>gnu/libz.so dest=/usr/lib/libz.so state=link

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> symlink imaging library files
  <span class="token key atrule">action</span><span class="token punctuation">:</span> file src=/usr/lib/x86_64<span class="token punctuation">-</span>linux<span class="token punctuation">-</span>gnu/libjpeg.so.62 dest=/usr/lib/x86_64<span class="token punctuation">-</span>linux<span class="token punctuation">-</span>gnu/libjpeg.so state=link

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> symlink imaging library files
  <span class="token key atrule">action</span><span class="token punctuation">:</span> file src=/usr/lib/x86_64<span class="token punctuation">-</span>linux<span class="token punctuation">-</span>gnu/libjpeg.so dest=/usr/lib/libjpeg.so state=link</code></pre></div>
<p>These tasks ensure that a few files are able to be found during the build process of PIL, Python's imaging library.</p>
<p>Following this are some tasks related to <strong>Nginx</strong>:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> remove default nginx site
  <span class="token key atrule">action</span><span class="token punctuation">:</span> file path=/etc/nginx/sites<span class="token punctuation">-</span>enabled/default state=absent

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> write nginx.conf
  <span class="token key atrule">action</span><span class="token punctuation">:</span> template src=templates/nginx.conf dest=/etc/nginx/nginx.conf</code></pre></div>
<p>With these tasks the default Nginx site is removed and a new Nginx configuration file is created from the <a href="https://github.com/mattupstate/ansible-tutorial/blob/master/devops/templates/nginx.conf">custom template</a>.</p>
<p>Following this are some tasks related to <strong>Supervisor</strong>:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create supervisord config folder
  <span class="token key atrule">action</span><span class="token punctuation">:</span> file dest=/etc/supervisor state=directory owner=root

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create supervisord config
  <span class="token key atrule">action</span><span class="token punctuation">:</span> template src=templates/supervisord.conf dest=/etc/supervisord.conf

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create supervisord init script
  <span class="token key atrule">action</span><span class="token punctuation">:</span> template src=templates/supervisord.sh dest=/etc/init.d/supervisord mode=0755

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start supervisord service and have it run during system startup
  <span class="token key atrule">action</span><span class="token punctuation">:</span> service name=supervisord state=started enabled=yes</code></pre></div>
<p>The first task creates a directory to contain various program configurations. Following this a Supervisor configuration file is created from the <a href="https://github.com/mattupstate/ansible-tutorial/blob/master/devops/templates/supervisord.conf">custom template</a> which will load all files located in the aforementioned directory. The third and fourth tasks setup Supervisor to run as a service and run when the system starts up.</p>
<p>And finally the last task:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create webapps directory
  <span class="token key atrule">action</span><span class="token punctuation">:</span> file dest=/srv/webapps state=directory</code></pre></div>
<p>This task simply creates a directory to hold all the server's web applications.</p>
<h3><a href=""></a>deploy.yml</h3>
<p>The <a href="https://github.com/mattupstate/ansible-tutorial/blob/master/devops/deploy.yml">deploy.yml</a> playbook is made specifically for the previous server setup.</p>
<h4>Configuration</h4>
<p>Just as with the <code class="language-text">server_setup.yml</code> playbook, you'll see the same contents at the top of the file specifying the host(s) and user.</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> webservers
  <span class="token key atrule">user</span><span class="token punctuation">:</span> ubuntu
  <span class="token key atrule">sudo</span><span class="token punctuation">:</span> <span class="token boolean important">True</span></code></pre></div>
<p>Following this are some variable definitions:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">vars</span><span class="token punctuation">:</span>
  <span class="token key atrule">app_name</span><span class="token punctuation">:</span> hello_flask
  <span class="token key atrule">repo_url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//github.com/mattupstate/ansible<span class="token punctuation">-</span>tutorial.git
  <span class="token key atrule">repo_remote</span><span class="token punctuation">:</span> origin
  <span class="token key atrule">repo_version</span><span class="token punctuation">:</span> master
  <span class="token key atrule">webapps_dir</span><span class="token punctuation">:</span> /srv/webapps
  <span class="token key atrule">wsgi_file</span><span class="token punctuation">:</span> wsgi.py
  <span class="token key atrule">wsgi_callable</span><span class="token punctuation">:</span> app</code></pre></div>
<p>These variables are used throughout the playbook and are also used when writing templates to the server.</p>
<h4>Tasks</h4>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ensure log directory
  <span class="token key atrule">action</span><span class="token punctuation">:</span> file dest=$<span class="token punctuation">{</span>webapps_dir<span class="token punctuation">}</span>/$<span class="token punctuation">{</span>app_name<span class="token punctuation">}</span>/log state=directory
</code></pre></div>
<p>This ensures the log directory is in place.</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy code from repository
  <span class="token key atrule">action</span><span class="token punctuation">:</span> git repo=$repo_url dest=$<span class="token punctuation">{</span>webapps_dir<span class="token punctuation">}</span>/$<span class="token punctuation">{</span>app_name<span class="token punctuation">}</span>/src remote=$repo_remote version=$repo_version</code></pre></div>
<p>This task retrieves the source code form the remote git repository and checks out the specified version/branch, in this case the <code class="language-text">HEAD</code> revision of the <code class="language-text">master</code> branch. Notice the usage of the variables defined before.</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install dependencies into virtualenv
  <span class="token key atrule">action</span><span class="token punctuation">:</span> pip requirements=$<span class="token punctuation">{</span>webapps_dir<span class="token punctuation">}</span>/$<span class="token punctuation">{</span>app_name<span class="token punctuation">}</span>/src/requirements.txt virtualenv=$<span class="token punctuation">{</span>webapps_dir<span class="token punctuation">}</span>/$<span class="token punctuation">{</span>app_name<span class="token punctuation">}</span>/venv state=present
</code></pre></div>
<p>This tasks installs the application's dependencies into the specified vitualenv using pip and the applicaiton's <code class="language-text">requirements.txt</code> file.</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create supervisor program config
  <span class="token key atrule">action</span><span class="token punctuation">:</span> template src=templates/supervisor.ini dest=/etc/supervisor/$<span class="token punctuation">{</span>app_name<span class="token punctuation">}</span>.ini
  <span class="token key atrule">notify</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> restart app</code></pre></div>
<p>This task creates or updates the application's Supervisor program configuration from a <a href="https://github.com/mattupstate/ansible-tutorial/blob/master/devops/templates/supervisor.ini">custom template</a>. If you look at the contents of the template you will see the previous defined variables being used. Additionally, this task defines a <code class="language-text">notify</code> action. This means that if the configuration file changes at all, Ansible will run the <code class="language-text">restart app</code> handler which is defined later on in the playbook.</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create nginx site config
  <span class="token key atrule">action</span><span class="token punctuation">:</span> template src=templates/nginx_site.conf dest=/etc/nginx/sites<span class="token punctuation">-</span>available/$<span class="token punctuation">{</span>app_name<span class="token punctuation">}</span>.conf
  <span class="token key atrule">notify</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> restart nginx

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> link nginx config
  <span class="token key atrule">action</span><span class="token punctuation">:</span> file src=/etc/nginx/sites<span class="token punctuation">-</span>available/$<span class="token punctuation">{</span>app_name<span class="token punctuation">}</span>.conf dest=/etc/nginx/sites<span class="token punctuation">-</span>enabled/$<span class="token punctuation">{</span>app_name<span class="token punctuation">}</span>.conf state=link</code></pre></div>
<p>These tasks creates or updates the applicatin's Nginx configuration from a <a href="https://github.com/mattupstate/ansible-tutorial/blob/master/devops/templates/nginx_site.conf">custom template</a> and ensures a symlink exists in the Nginx <code class="language-text">sites-enabled</code> directory. This task also defines a <code class="language-text">notify</code> action and in this case, if the configuration changes at all, Nginx will be restarted.</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start app
  <span class="token key atrule">action</span><span class="token punctuation">:</span> supervisorctl name=$<span class="token punctuation">{</span>app_name<span class="token punctuation">}</span> state=started</code></pre></div>
<p>And lastly, this task ensures the application is running, if it is running already nothing will be affected.</p>
<p>This task ensures the symlink for the Nginx configuration</p>
<h4>Handlers</h4>
<p>Some of the previous tasks use Ansible's <code class="language-text">notify</code> action. In the case those tasks make a change on the server Ansible will run a handler with the given name. The following are the handlers:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> restart app
  <span class="token key atrule">action</span><span class="token punctuation">:</span> supervisorctl name=$<span class="token punctuation">{</span>app_name<span class="token punctuation">}</span> state=restarted</code></pre></div>
<p>This handler will ensure the application is restarted via supervisorctl so long as it is already running.</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> restart nginx
  <span class="token key atrule">action</span><span class="token punctuation">:</span> service name=nginx state=restarted</code></pre></div>
<p>This handler will ensure Nginx is restarted so long as it is already running.</p>
<h2><a href=""></a>Notes</h2>
<p>At the time of writing this tutorial there was a small problem with the Nginx PPA and the init script that was packaged with it. Luckily a <a href="https://bugs.launchpad.net/nginx/+bug/1033856">bug was filed</a> at Launchpad so I figured out what was going on. If you experience this problem simply replace the contents of the <code class="language-text">/etc/init.d/nginx</code> file with this <a href="https://launchpadlibrarian.net/112190683/nginx.txt">alternative init script</a>.</p></div></div><div class="pl-10 pr-10 pt-6 max-w-3xl mx-auto text-center text-xs mb-5 font-mono"><hr class="mt-8 mb-3"/>Copyright © Matthew Wright 2022<br/>Built with <a href="https://www.gatsbyjs.com/">Gatsby</a>, <a href="https://tailwindcss.com/">tailwindcss</a> &amp; <a href="https://pages.github.com/">GitHub Pages</a><br/>Find me on <a href="https://mastodon.social/@mattupstate" rel="me">Mastodon</a></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EKT2WF2WDQ"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-EKT2WF2WDQ', {"send_page_view":false});
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/flask-wsgi-application-deployment-with-ubuntu-ansible-nginx-supervisor-and-uwsgi/";window.___webpackCompilationHash="27953d9332d750d3ca74";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-c5c0181d4d3c3787c4a6.js"],"app":["/app-f1d5148060cce5abe405.js"],"component---src-pages-404-js":["/component---src-pages-404-js-fcfd776236d0c701b588.js"],"component---src-pages-etc-js":["/component---src-pages-etc-js-fffe2ea45aab2f531e71.js"],"component---src-pages-index-js":["/component---src-pages-index-js-3cbe8272dfbe42e348d1.js"],"component---src-pages-markdown-remark-frontmatter-slug-js":["/component---src-pages-markdown-remark-frontmatter-slug-js-a650d894f7d1c2a811e6.js"],"component---src-pages-talks-js":["/component---src-pages-talks-js-5e587e6275856c4b6519.js"],"component---src-pages-work-js":["/component---src-pages-work-js-90a6c2b2d4c8822fbaa0.js"]};/*]]>*/</script><script src="/polyfill-c5c0181d4d3c3787c4a6.js" nomodule=""></script><script src="/app-f1d5148060cce5abe405.js" async=""></script><script src="/532a2f07-22a38091beea14ab1e64.js" async=""></script><script src="/framework-f71dcd04c2811ba676c8.js" async=""></script><script src="/webpack-runtime-868a2427797d52a8ad6c.js" async=""></script></body></html>