<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 4.24.8"/><meta data-react-helmet="true" name="description" content="Matt &#x27;Upstate&#x27; Wright (He/him). Engineering team leader. Open source author and contributor. Aging hardcore punk enthusiast. LFC supporter."/><meta data-react-helmet="true" name="keywords" content="software,engineering,leadership,python,programming,open source"/><meta data-react-helmet="true" property="og:title" content="Database Migrations with Alembic, SQLAlchemy and Flask"/><meta data-react-helmet="true" property="og:description" content="Matt &#x27;Upstate&#x27; Wright (He/him). Engineering team leader. Open source author and contributor. Aging hardcore punk enthusiast. LFC supporter."/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:creator" content="Matthew Wright"/><meta data-react-helmet="true" name="twitter:title" content="Database Migrations with Alembic, SQLAlchemy and Flask"/><meta data-react-helmet="true" name="twitter:description" content="Matt &#x27;Upstate&#x27; Wright (He/him). Engineering team leader. Open source author and contributor. Aging hardcore punk enthusiast. LFC supporter."/><meta data-react-helmet="true" property="og:image" content="https://mattupstate.com/static/9798db320c5cad183af92ab85933ac64/38397/headshot-summary.png"/><meta data-react-helmet="true" property="og:image:width" content="2122"/><meta data-react-helmet="true" property="og:image:height" content="1070"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><style data-href="/styles.c743ec910f51898a4794.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{background:#073642}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#073642}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{background:#eee8d5;color:#657b83}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}

/*! tailwindcss v2.2.19 | MIT License | https://tailwindcss.com */

/*! modern-normalize v1.1.0 | MIT License | https://github.com/sindresorhus/modern-normalize */html{-webkit-text-size-adjust:100%;line-height:1.15;-moz-tab-size:4;-o-tab-size:4;tab-size:4}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;margin:0}hr{color:inherit;height:0}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{border-color:inherit;text-indent:0}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}button{-webkit-appearance:button}::-moz-focus-inner{border-style:none;padding:0}legend{padding:0}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}html{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}body{font-family:inherit;line-height:inherit}*,:after,:before{border:0 solid;box-sizing:border-box}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:#9ca3af;opacity:1}input::placeholder,textarea::placeholder{color:#9ca3af;opacity:1}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{color:inherit;line-height:inherit;padding:0}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{height:auto;max-width:100%}*,:after,:before{--tw-border-opacity:1;border-color:rgba(229,231,235,var(--tw-border-opacity))}h1{font-size:1.5rem;line-height:2rem}h2{font-size:1.25rem;margin-bottom:.5rem}h2,h3{line-height:1.75rem}h3{font-size:1.125rem}h4,h5{font-size:1rem;line-height:1.5rem}h5{--tw-text-opacity:1;color:rgba(75,85,99,var(--tw-text-opacity));font-weight:700}p{font-size:.875rem;line-height:1.25rem}blockquote,p{margin-bottom:1rem}blockquote{--tw-bg-opacity:1;--tw-text-opacity:1;background-color:rgba(249,250,251,var(--tw-bg-opacity));border-left:3px solid gray;color:rgba(107,114,128,var(--tw-text-opacity));font-style:italic;padding:1rem}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}@media (min-width:1536px){.container{max-width:1536px}}.mx-auto{margin-left:auto;margin-right:auto}.mt-8{margin-top:2rem}.mr-0{margin-right:0}.mr-3{margin-right:.75rem}.mb-1{margin-bottom:.25rem}.mb-3{margin-bottom:.75rem}.mb-5{margin-bottom:1.25rem}.flex{display:flex}.table{display:table}.max-w-3xl{max-width:48rem}@keyframes spin{to{transform:rotate(1turn)}}@keyframes ping{75%,to{opacity:0;transform:scale(2)}}@keyframes pulse{50%{opacity:.5}}@keyframes bounce{0%,to{animation-timing-function:cubic-bezier(.8,0,1,1);transform:translateY(-25%)}50%{animation-timing-function:cubic-bezier(0,0,.2,1);transform:none}}.flex-wrap{flex-wrap:wrap}.justify-start{justify-content:flex-start}.border-2{border-width:2px}.border{border-width:1px}.bg-gray-50{--tw-bg-opacity:1;background-color:rgba(249,250,251,var(--tw-bg-opacity))}.p-4{padding:1rem}.pt-2{padding-top:.5rem}.pt-6{padding-top:1.5rem}.pr-8{padding-right:2rem}.pr-10{padding-right:2.5rem}.pb-3{padding-bottom:.75rem}.pl-5{padding-left:1.25rem}.pl-10{padding-left:2.5rem}.text-center{text-align:center}.font-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}.text-xs{font-size:.75rem;line-height:1rem}.text-gray-500{--tw-text-opacity:1;color:rgba(107,114,128,var(--tw-text-opacity))}.text-gray-600{--tw-text-opacity:1;color:rgba(75,85,99,var(--tw-text-opacity))}.hover\:text-gray-500:hover{--tw-text-opacity:1;color:rgba(107,114,128,var(--tw-text-opacity))}*,:after,:before{--tw-shadow:0 0 #0000;--tw-ring-inset:var(--tw-empty,/*!*/ /*!*/);--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000}.filter{--tw-blur:var(--tw-empty,/*!*/ /*!*/);--tw-brightness:var(--tw-empty,/*!*/ /*!*/);--tw-contrast:var(--tw-empty,/*!*/ /*!*/);--tw-grayscale:var(--tw-empty,/*!*/ /*!*/);--tw-hue-rotate:var(--tw-empty,/*!*/ /*!*/);--tw-invert:var(--tw-empty,/*!*/ /*!*/);--tw-saturate:var(--tw-empty,/*!*/ /*!*/);--tw-sepia:var(--tw-empty,/*!*/ /*!*/);--tw-drop-shadow:var(--tw-empty,/*!*/ /*!*/);filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}blockquote>p{margin-bottom:0}code[class=language-text],pre[class=language-text]{font-size:.75rem;line-height:1rem}.navbar{position:sticky;top:0}.blog-post a{--tw-text-opacity:1;color:rgba(37,99,235,var(--tw-text-opacity));text-decoration:underline}.blog-post ul{font-size:.875rem;line-height:1.25rem;list-style-position:inside;list-style-type:disc;margin-bottom:1rem;margin-left:.75rem}.blog-links a{--tw-text-opacity:1;color:rgba(37,99,235,var(--tw-text-opacity));text-decoration:underline}.work ul{list-style-position:outside;list-style-type:disc;margin-bottom:1rem;margin-left:1rem}.employment p,.work ul{font-size:.75rem;line-height:1rem}.work h3{font-weight:500}.work h4{margin-bottom:.25rem}.talks a{--tw-text-opacity:1;color:rgba(37,99,235,var(--tw-text-opacity));text-decoration:underline}.talk-item{margin-bottom:2rem}.employment-duration{--tw-text-opacity:1;color:rgba(156,163,175,var(--tw-text-opacity));font-size:.875rem;line-height:1.25rem;margin-left:.25rem}.etc a,.work a{--tw-text-opacity:1;color:rgba(37,99,235,var(--tw-text-opacity));text-decoration:underline}.etc ul{font-size:.875rem;line-height:1.25rem;list-style-position:inside;list-style-type:disc;margin-bottom:1rem;margin-left:.75rem}@media (min-width:640px){.sm\:flex{display:flex}.sm\:w-2\/5{width:40%}.sm\:w-3\/5{width:60%}.sm\:justify-between{justify-content:space-between}.sm\:pt-0{padding-top:0}.sm\:pl-0{padding-left:0}}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><title data-react-helmet="true">Database Migrations with Alembic, SQLAlchemy and Flask | mattupstate.com</title><link data-react-helmet="true" rel="canonical" href="https://mattupstate.com/blog/database-migrations-with-alembic-sqlalchemy-and-flask"/><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><nav class="p-4 bg-gray-50 font-mono navbar"><div class="sm:flex sm:justify-between max-w-3xl mx-auto"><div>$ <a class="hover:text-gray-500" href="/">matt</a></div><div class="pl-5 pt-2 sm:pl-0 sm:pt-0"><a class="mr-3 hover:text-gray-500" href="/work">~/work</a><a class="mr-3 hover:text-gray-500" href="/talks">~/talks</a><a class="mr-0 hover:text-gray-500" href="/etc">~/etc</a></div></div></nav><div class="pl-10 pr-10 pt-6 max-w-3xl mx-auto blog-post"><h1 class="mb-1">Database Migrations with Alembic, SQLAlchemy and Flask</h1><h5 class="mb-3 text-xs text-gray-500 font-mono">Published on <!-- -->November 16, 2012</h5><hr class="mb-3"/><div><p>Recently I started using <a href="http://alembic.readthedocs.org/">Alembic</a> for managing database migrations for a Flask application at <a href="http://www.chatid.com/">work</a>. Alembic is developed and maintained by the maker of SQLAlchemy, thus it was immediately an attractive tool. I've been using it the last month or so and without a doubt I've had a pleasant experience using it so far. In this post I want to share a couple of things that I did with Alembic while developing a Flask app that might prove useful for other developers out there.</p>
<h3>The Database Connection</h3>
<p>Alembic, mostly, makes no assumptions about your database connection. Generally speaking, when you initialize Alembic for your project you will use the following command:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">alembic init alembic</code></pre></div>
<p>The only assumption Alembic makes during this process is that you'll have one place to store your database connection setting. That is in the generated file named <code class="language-text">alembic.ini</code>. In this file there will be a line that reads:</p>
<div class="gatsby-highlight" data-language="ini"><pre class="language-ini"><code class="language-ini"><span class="token key attr-name">sqlalchemy.url</span> <span class="token punctuation">=</span> <span class="token value attr-value">driver://user:pass@localhost/dbname</span></code></pre></div>
<p>This is a great place to get started but keeping the database connection setting in this file isn't sustainable for any application that has various environments or differences in connection settings.</p>
<p>Alembic also creates another file named <code class="language-text">env.py</code> that is located in the folder named <code class="language-text">alembic</code>. It is in this file that Alembic creates the SQLAlchemy engine object using the options specified in <code class="language-text">alembic.ini</code>. This happens in a method called <code class="language-text">run_migrations_online</code>.</p>
<p>It is also in this file that you can work some magic so that Alembic will connect to the appropriate database. In my case I was developing a Flask application using the Flask-SQLALchemy extension and the database connection is specified in the application configuration file: <code class="language-text">myapp/config.py</code>. Given that my configuration file is a plain Python file it was very easy to pass that value to Alembic. The <code class="language-text">run_migrations_online</code> method of my <code class="language-text">env.py</code> file now looks like this:</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">run_migrations_online</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Override sqlalchemy.url value to application's value</span>
    alembic_config <span class="token operator">=</span> config<span class="token punctuation">.</span>get_section<span class="token punctuation">(</span>config<span class="token punctuation">.</span>config_ini_section<span class="token punctuation">)</span>
    <span class="token keyword">from</span> myapp <span class="token keyword">import</span> config <span class="token keyword">as</span> app_config
    alembic_config<span class="token punctuation">[</span><span class="token string">'sqlalchemy.url'</span><span class="token punctuation">]</span> <span class="token operator">=</span> app_config<span class="token punctuation">.</span>SQLALCHEMY_DATABASE_URI

    engine <span class="token operator">=</span> engine_from_config<span class="token punctuation">(</span>
                alembic_config<span class="token punctuation">,</span>
                prefix<span class="token operator">=</span><span class="token string">'sqlalchemy.'</span><span class="token punctuation">,</span>
                poolclass<span class="token operator">=</span>pool<span class="token punctuation">.</span>NullPool<span class="token punctuation">)</span>

    connection <span class="token operator">=</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
    context<span class="token punctuation">.</span>configure<span class="token punctuation">(</span>
                connection<span class="token operator">=</span>connection<span class="token punctuation">,</span>
                target_metadata<span class="token operator">=</span>target_metadata
                <span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> context<span class="token punctuation">.</span>begin_transaction<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            context<span class="token punctuation">.</span>run_migrations<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        connection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<p>This file now works in all the application's environments so long as <code class="language-text">config.py</code> is properly configured.</p>
<h3>Autogenerating Migrations</h3>
<p>One handy feature of Alembic is the ability to autogenerate migration files based on your SQLAlchemy models. This feature simply relies on specifying the MetaData object for your models. Given that I was using Flask-SQLAlchemy all I had to do was pass the preconfigured MetaData object to Alembic. This object is accessible on the instance of the Flask-SQLAlchemy extension object which in my app happens to in the <code class="language-text">myapp.core</code> module.</p>
<p>Within <code class="language-text">env.py</code> you'll see a commented out line that may look like the following:</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token comment"># target_metadata = mymodel.Base.metadata</span></code></pre></div>
<p>In my case I changed this the following:</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> myapp<span class="token punctuation">.</span>core <span class="token keyword">import</span> db
target_metadata <span class="token operator">=</span> db<span class="token punctuation">.</span>metadata</code></pre></div>
<p>Now with my properly configured database connection and MetaData object in place I can autogenerate migrations with the following command:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">alembic revision <span class="token parameter variable">--autogenerate</span> <span class="token parameter variable">-m</span> <span class="token string">"Added some table"</span></code></pre></div>
<p>Just bear in mind that autogenerating migrations isn't the end all be all command. I does not account for everything that can be done during a migration. For instance, if you want to add indexes on particular fields you'll need to write that in yourself. Lastly, if you add anything by hand remember to modify both the <code class="language-text">upgrade</code> and <code class="language-text">downgrade</code> methods!</p></div></div><div class="pl-10 pr-10 pt-6 max-w-3xl mx-auto text-center text-xs mb-5 font-mono"><hr class="mt-8 mb-3"/>Copyright © Matthew Wright 2022<br/>Built with <a href="https://www.gatsbyjs.com/">Gatsby</a>, <a href="https://tailwindcss.com/">tailwindcss</a> &amp; <a href="https://pages.github.com/">GitHub Pages</a><br/>Find me on <a href="https://mastodon.social/@mattupstate" rel="me">Mastodon</a></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EKT2WF2WDQ"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-EKT2WF2WDQ', {"send_page_view":false});
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/database-migrations-with-alembic-sqlalchemy-and-flask/";window.___webpackCompilationHash="27953d9332d750d3ca74";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-c5c0181d4d3c3787c4a6.js"],"app":["/app-f1d5148060cce5abe405.js"],"component---src-pages-404-js":["/component---src-pages-404-js-fcfd776236d0c701b588.js"],"component---src-pages-etc-js":["/component---src-pages-etc-js-fffe2ea45aab2f531e71.js"],"component---src-pages-index-js":["/component---src-pages-index-js-3cbe8272dfbe42e348d1.js"],"component---src-pages-markdown-remark-frontmatter-slug-js":["/component---src-pages-markdown-remark-frontmatter-slug-js-a650d894f7d1c2a811e6.js"],"component---src-pages-talks-js":["/component---src-pages-talks-js-5e587e6275856c4b6519.js"],"component---src-pages-work-js":["/component---src-pages-work-js-90a6c2b2d4c8822fbaa0.js"]};/*]]>*/</script><script src="/polyfill-c5c0181d4d3c3787c4a6.js" nomodule=""></script><script src="/app-f1d5148060cce5abe405.js" async=""></script><script src="/532a2f07-22a38091beea14ab1e64.js" async=""></script><script src="/framework-f71dcd04c2811ba676c8.js" async=""></script><script src="/webpack-runtime-868a2427797d52a8ad6c.js" async=""></script></body></html>